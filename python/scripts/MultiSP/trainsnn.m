function [net,tr,output,E]=trainsnn(net,ti,td,VV)


% CHECK
% =======
if nargin<3, error('Not enougth input arguments');end
if nargin<4, VV=[];end


epochs      = net.trainParam.epochs;
goal        = net.trainParam.goal;
lr          = net.trainParam.lr;
lr_gamma    = net.trainParam.lr_gamma;
lr_delay    = net.trainParam.lr_delay;
negWeights  = net.trainParam.negWeights;
show        = net.trainParam.show;
max_fail    = net.trainParam.max_fail;


numLayers   = net.numLayers;
s           = net.size;
this='TRAINGD';
doValidation = ~isempty(VV);


stop = '';
% w=[12.5326969873363,15.0623819202982,20.9932233975180,29.2222263899464,40.6209344440807,34.5413330992963,23.3504493703590,16.2121493422744,5.63530908807850,3.22875915243768;7.01152419186053,11.5984729544863,7.81381169429451,11.3737517274702,15.1767846037617,21.1046773938073,29.2467305574955,36.2219679496488,38.5925108830865,21.7426468710579;10.5435608208857,14.7501458701560,20.6817721523539,29.1254687811942,38.4148350615915,36.9436591602096,23.4659177036622,10.5062674382598,9.21427712649391,9.80183744048060;7.63968679541785,7.51425562106132,7.81381169429451,10.8947358393773,15.1767846037617,21.1046773938073,29.2467305574955,35.7598505620361,39.1772714984956,26.7611751413332;13.2643215694440,18.0695046105864,24.0156002991456,30.2479405520807,34.0494284310932,38.7345052842680,24.0924483814954,12.7231382084220,6.60489264717847,5.19828130108268;17.9007992168754,24.6267976408943,33.4023540198639,43.5304320894535,40.5277907233660,32.3028041588142,12.0118468292411,6.77329156268980,2.20185381224731,7.81513847413410;9.63567959863385,9.24948555007932,18.1627027645491,22.4838317362458,26.2137193511126,33.2149788422815,42.5267741339752,42.4784588140581,30.8202499915400,12.1413646524277;17.6525770263023,24.3795352645337,33.3268153057615,44.3072019263719,44.4947199341925,31.1995259386123,12.6801202250592,12.0280183514649,5.21986704560621,2.54060947895206;7.67294591170951,16.3410609003127,14.4182032198241,17.5871945114196,27.7588183521007,35.4683280433081,42.1597817504891,44.5106083498868,27.8375071443566,20.5260047931082;24.1349118930406,28.3210124482542,35.9794393454507,43.0083141316389,40.0652719532605,27.7536538051678,15.2711404835178,5.46986235329406,4.00308296436061,2.07123118021191;20.6481756669634,29.8260219579779,36.4817810531877,49.2816968734243,43.2531355657916,29.5420985060503,16.9411488474987,10.5749224300217,8.31700095920353,7.47007147529563;9.89748562070686,13.1301249506293,13.7130783932431,17.6446825252389,25.3592210758914,33.5016144788208,43.9493598985452,47.2610036453293,27.2566895468062,19.3571095213724;20.2295740943998,26.7395548603091,33.9718903621302,48.4688693380547,43.1455615102448,34.3431025954119,18.7996763671140,7.71506360475370,6.32510779098555,1.92250929023858;9.91666763893919,9.29361868765101,14.6644334254488,19.2102795038806,24.4147452259240,36.6294909381717,43.5798385639302,42.7368706965711,30.2247009120616,21.9524097997236;22.7549359187219,28.7325379452012,36.4214495610700,44.2482438559665,37.9664183453884,22.9853070456180,15.4379735100787,11.4518751326433,8.22406973244867,5.71533554557490;13.7092863611230,20.5161595511798,24.6997319573426,32.8099029721622,41.6209525433066,33.4401994998510,24.2670121857034,14.6390700607525,6.66526099251023,7.79933840419153;11.1642384683252,8.60999617868673,8.69154650727380,15.3488591667397,17.2305315593633,26.0095229879097,33.7852565576191,44.8727325923156,34.4076243238502,25.2710223321945;12.9716831371923,17.9511828968993,24.6390103063224,33.2335479597544,39.9468299369149,39.4132670409743,21.4584938854250,12.3285096588457,2.90625426705614,1.71419861599660;7.71478820977974,7.95367381458430,13.7713159875098,15.8712465861115,16.9682862694392,23.7520355869943,33.9409390892608,41.4631955265508,34.7834871402558,21.7001801721954;15.0550736864672,20.4353279188665,27.1149948880209,33.3644662099155,35.9575502521349,35.6408395778200,18.6466717780077,10.1355622640578,5.71423282861176,7.82970483204641;22.0131225727434,32.3532847429339,38.6863785491015,31.9575298851320,23.0734816477559,9.76414895148096,7.01511403542842,6.36258723520761,3.05015676988800,5.88222349883599;12.5550545332090,15.8332360308751,16.6370992034121,21.7457148939561,29.2252605129369,42.0517585622745,37.6714840781857,19.3178853264822,12.1780628144374,9.87822658419707;23.5354321482947,31.7244645476109,38.6466285666341,37.8773634389786,27.3335574695178,15.1672358919236,10.3951053292231,7.40557751260886,6.80089590024078,5.61637371774788;12.0663494261341,16.7267077687591,18.1469394348482,26.6494620703049,33.4514320723623,38.9424368140193,38.0201093882167,20.8136874176488,14.8953549598725,6.59338009341720;28.2225864840567,35.4416743600444,35.5815457148186,34.4403809621173,19.4512260070487,8.52399438131392,10.9261162128872,8.57969838760131,8.91455637376907,1.63747870855402;12.4590705323672,17.3301464229757,24.0288139063408,33.1071793537993,47.2628860123990,45.1431208689673,29.7570226037943,19.3182361011795,15.0229316183620,3.87672933392978;4.43293856831096,10.6302363672867,8.62824165602316,12.0310056595776,16.7616016892823,23.3138169582598,32.3226274206902,41.8856039013510,47.1094092191587,33.8226334153173;13.2784131659208,16.5722429494582,23.1317987092479,32.2921877638884,43.7355976814172,43.4981208761852,36.3690150246756,21.1998188461652,12.5255217133363,5.21495132470866;5.57098503271441,6.18521935992881,8.62824165602316,12.0310056595776,16.7616016892823,23.3138169582598,32.3226274206902,41.8856039013510,45.3921075029423,31.7846606926514;15.7639449027263,20.6937915755359,27.6044137766545,35.0562664888852,39.4957949633275,37.9928855345287,25.1401849531269,12.1259568628812,13.2822356417637,6.59965021860017;24.4608307989670,30.1723562352760,36.2171405242731,36.9650178132706,31.0611130783531,11.7712152233836,11.1076843434930,9.60275454404103,7.50231615880928,2.26979137566814;13.1626487331737,16.4322434090711,13.7092689244657,20.4579918760703,25.7495620059282,35.4504735725839,41.8324289238594,32.4416502749007,12.9212200945808,5.67561568148995;19.8169346560559,30.4021334307499,34.9300800712106,32.1468757178775,31.8169915603301,13.6573130821393,11.6740186256346,7.89115555248932,6.78810689688030,7.63524818546107;14.8381688011947,15.7473936396992,19.8197245933281,18.1917107891182,25.7495620059282,34.6668958167642,37.8952310312368,31.6376707464963,14.3029964859237,6.24652788726420;23.2467040112116,31.7009472594517,36.0556491841842,38.1533594854273,17.8858173500144,8.88770878060199,10.7144612724360,8.11451243570418,7.91886299788144,3.53873021873125;21.2203860169462,30.9710819264216,35.7157176764770,34.8848969464026,26.1343018661686,9.52219079535584,3.02946738989075,3.51423660925788,1.60716081181958,3.09792867673165;12.8995542146068,16.9525027307196,18.9388012914541,25.2890213016282,28.3938432469513,37.1503146976482,34.6524184404717,18.2557768542356,14.0981393085841,3.55751725830490;26.0526635746007,29.8061737239781,43.9298955141008,36.3955671444902,23.0359680114335,13.9255232537267,10.9618164681126,7.58954955961618,9.32860345895587,3.44751415074228;15.1274318216082,15.8118361907534,20.5579133145387,22.1019990074093,28.3938432469513,40.0666687927396,34.8801280204908,17.3151208222481,12.5860959189822,7.04893998919353;27.3777975788034,29.7829744994420,34.9740250102471,31.4007608507470,20.1307829032969,9.55688732991794,9.35152481531172,7.48201573654616,3.00445386255508,6.80525569507955;13.1409074437245,16.9134283115186,23.3785401022709,35.2969918240787,40.0314600546523,43.2130260388875,28.4920855657646,17.0036925720696,11.7037738681582,6.09830904336082;4.43686399299644,11.5802503280160,8.62183343395116,11.9968197362075,19.0245539156990,22.9649516366136,31.3287368943784,45.1219685861367,42.8211484596304,28.1298578620042;11.7373145495149,18.4245589838972,22.8507677433183,31.9845979815873,45.1790219541212,38.7605233300452,24.9101169557204,12.1737245609596,11.0673820621723,6.01317330706670;8.75128481643825,6.92387922100337,8.62183343395116,11.9968197362075,19.3338612738190,22.9649516366136,31.3287368943784,40.7255945690407,41.2944701134315,25.2019288066734;14.4736434755267,19.7236512004778,27.4208545091047,33.0940600274287,38.9770824980274,37.1388674670959,26.9097766138910,13.9386878264488,5.71310874540553,8.31256968041757;12.3621493255401,17.1238064698835,23.2805757965058,34.9516044221921,41.1151074172369,28.4383760954085,15.0190746212993,9.62454130338923,9.87103289973066,2.71884853464440;5.86785966266973,7.49962667914322,9.12443925694415,11.6432760476705,16.2603573880232,22.7226682881972,30.9824654051604,36.5821865787415,29.3758888480115,19.5624450312294;12.3311921295256,17.0244129568076,23.2561869480387,31.0243766470325,32.7788467378108,36.4327596585697,21.6728819663466,12.4467001142144,2.68702380445303,6.87819463086344;4.28071093631522,8.26303568865034,11.6578737943674,11.6432760476705,16.2603573880232,23.4321210022619,30.9824654051604,35.7040023564172,29.0817803220658,17.9476452470188;16.1765834580477,19.3443290333775,25.4084040185610,33.5355149242997,36.2017656458173,25.9138264039677,17.8173137256625,9.42192339988343,7.16257353734133,6.64287872688913;30.9674257760450,35.7641889640073,44.4699027958419,39.8204743795334,22.8573162908183,11.6579230331348,7.60809668949932,9.03416023159112,7.85036705942278,2.49636473899914;14.3000032891076,17.2927345523091,19.8333862159698,25.9234860055850,35.9942992421341,47.7975866679628,50.4810025892728,24.0784630247540,19.4660689944382,5.54220360809276;28.9297998787087,37.1881467669100,49.2700394217578,38.1093857798407,32.3362800239462,20.0765509966488,3.94510521977852,5.47979444136634,4.70061947076271,9.31743109888207;13.2132222165888,14.9497559863568,21.0930756864483,31.6571233937040,38.6734905301552,47.3512719709372,45.6601318110757,30.2103694460611,16.0035664802624,9.99716626725968;31.3943412555396,38.5197265397141,46.2161055679136,39.9584692771281,17.4172831102344,11.4215154553452,10.7716991504852,6.36581237549098,6.56875789360569,5.67441451124156;26.3381054783712,30.0106308478192,42.3510249659611,28.8434498574480,24.9428420486372,6.85137424863113,9.35040517872685,1.79377918026947,3.09913884266488,5.52207437659423;12.7278746487080,15.4899002856478,23.0910156890421,27.5780497936184,33.7082594483169,38.0549963284222,31.6377612357599,18.9603848420018,10.7847455300386,7.56865923704521;21.8520210415307,30.0652175303633,37.2251854062094,35.1084646868979,19.5153853942861,5.20049863901826,3.03122901225548,1.63047260180336,7.93455821233283,9.70839814294245;16.3160475481257,19.1281331453222,20.6810003375722,25.1797007617247,34.4904483856093,40.4980754009002,35.7074563182295,17.2281660247018,14.7513153378630,2.37375756096571;26.3270935673692,30.7143242177021,32.4158321689445,30.3785403594586,18.6833528407047,6.58224289480390,4.73525728782560,5.94506806211916,7.94129200190340,5.16799483301893;33.2634480446552,37.9622382671092,49.9830658518384,42.1967526549027,27.6770679058318,10.2278865005217,6.98006264301806,8.51359782477895,6.96145435243567,8.68503399103885;11.2300542671590,20.3920831534015,24.9314964170294,30.5688571330901,37.1476564665819,46.2353498388125,50.3483560401779,26.9153096594002,13.1618796368385,6.64495824611980;28.0723222736281,40.9623274599220,50.5278285809049,44.8849516839425,28.7516793445034,13.9031061926395,4.89510216180391,1.23948537618568,1.96709617621529,7.82565018828163;11.1424881140004,17.2110331993143,21.1023945728078,26.8683574638942,36.6331861678173,46.2353498388125,45.7776006481229,26.7717622977754,10.1366845541243,8.25343054565446;31.4085506773380,43.0534179423246,47.5474870722022,36.4387621071803,23.8500555203019,6.93582672545125,8.92597226764628,5.15888989426962,7.98243673601118,7.37877417373085;24.7441989372802,24.2613461152503,24.4370142009681,17.6227809269875,16.6455869516378,8.13649716775978,4.62387921398644,9.00750453129212,6.67116942182881,8.24911235436246;13.5216446085406,14.8053329251853,16.3135775481065,20.9065647399480,22.6704935947720,25.6669482376415,27.7253275990703,12.6854580688973,8.01337320106275,4.87616880400158;21.8746818314697,28.5546990923059,26.7318399199923,19.9453023417199,11.5290943553788,2.97294981457239,9.40184905781015,7.95579402011570,8.26047707367122,2.22456868173156;8.70544730122832,12.5031082992796,17.3806388013932,16.0844305546940,19.8931101442925,24.8078021185703,23.5987087553150,16.4543022262356,4.53661630928836,6.02143282908515;23.8205284841714,28.6398036341833,29.7021127170112,15.7650677562363,12.6120088946348,1.96367846978773,9.56423110571022,4.52408527355084,7.29617443653996,4.34101511955084;22.8346430952440,23.6142407959418,21.7938941284668,16.6718241103642,8.61969316105812,9.36549612639407,1.25848536501653,9.42273935591623,2.70428812977035,9.12374836470385;13.7516567866636,9.49781733267782,14.7979547737942,17.5169839187908,26.7239199195033,27.3301567336961,26.0761386817134,8.51831200441067,1.97862936588310,6.65220582039416;22.9140546427296,21.3819701724492,22.5869676918233,14.2317710986918,10.8988237104965,9.81652516717499,6.06825067490626,3.41277647653715,9.86741956009701,5.72711576491052;7.39826116647755,9.86433400177296,19.8448532639607,21.0032745899940,19.8110867008642,29.8728359430266,24.8824309025032,9.27560633906688,2.82028344809455,6.03838568777801;20.0517354434420,24.9614775451089,29.3121291988184,13.9090489620652,9.07125900590726,1.51304012639392,5.51300409999732,8.52692035653542,5.75322145482384,9.13867829241758;20.7500436684897,28.7072458491338,39.3797992554356,53.0985729400620,74.7828742660545,84.5214546216065,78.9603326855938,48.0202808244805,15.3273524426230,2.52899464547537;16.5178759562203,22.9231998195181,31.6402843069104,43.2017765920198,57.6948097110773,76.5775000077986,86.5938941585136,69.7632610520819,34.1781155655371,18.1796755668195;16.0692330597415,22.3105415575093,30.8218751559948,42.1591498680143,56.5103261431421,77.0797376197155,90.1698434086084,77.5920563237265,39.0045009439046,16.2599309152602;18.6434678490421,25.8279660239232,35.5263955821078,48.1691091444788,63.3872749742037,83.9829253771598,86.7994732033664,59.5193843732209,31.2709769131970,6.50645443309422;11.4980499488496,15.9961711973476,22.1867738250783,30.5898802344620,41.6742809663902,55.3957384405765,73.4648762877808,85.1121160858503,54.2920923031098,28.9998076622376;22.7538107063547,31.4289256163597,42.9748753298437,57.5631865910929,79.4934172315063,91.9063059078350,77.7124825236346,41.0083579165835,6.67467033176026,9.20153262776039;12.3637706738748,17.2030385779610,23.8674416866849,32.9255160574696,44.9069440488330,69.4230056955614,77.4331233232433,88.6036320698435,66.7559244018081,31.0479127584054;10.9117042839370,15.1936150007541,21.1095432239306,29.2028991313537,40.0550425232813,59.2810424353062,72.4557589936660,89.5499384457399,83.2106149849547,39.2958479558465;19.9501453205902,27.6077751966095,37.8912419375109,51.1458320594065,66.6617565739693,90.1061239233790,82.4476336693649,51.3733231289460,29.0389207900895,6.94009055171894;19.0227308762090,26.3630251558925,36.2887743006193,49.2756179228800,65.0471234111582,87.3819437947229,87.8284070660393,55.6076262444979,20.5604902907327,5.47254907734416;12.2909421606362,17.1025406804214,23.7302911559938,32.7425489247684,44.6745401780472,60.6234703713338,80.4923412703268,86.0982438765860,65.2456497552910,33.8138535012304;9.73361705795612,13.5565214568173,18.8439851873534,26.0932221618313,35.8569350948865,48.6969258959312,70.6863932066921,84.5637173500079,80.4051098224418,51.1841444411755;11.5564556559526,16.0849501648376,22.3304292533683,30.8440655567045,42.1749915166990,62.3935058020071,77.7123334111291,92.9614847473764,76.9816630645051,41.1819153886174;10.5962853745315,12.8648920344497,13.3998873914230,12.3580274071414,0,0,0,0,0,0.00317401625577775;14.4283281404603,14.8061000258121,16.0987005165387,10.7497373157646,0,0,0,0,0,0];
% w=[21814,28542,31899,12944,3721,7646,14436,14330,9561,4886;20872,20061,18221,6003,6170,7002,23683,35324,17188,10214;16433,19765,25337,21847,17746,11774,21039,21552,16500,7900;13866,18116,21662,24070,14669,11573,19430,29421,17322,11028;9530,11809,19818,32869,43593,32370,20043,15756,9936,6424;28496,29211,18466,12412,4032,12377,8018,7926,8124,1494;23368,19261,14362,6449,10721,13298,20859,22478,8687,6764;20584,19183,24299,21897,14466,17749,20076,13757,4087,2104;13927,21420,23405,18549,12839,15541,18335,17020,12433,7204;9814,17003,29474,44018,35531,20687,8356,8420,1723,9656;26950,27648,22847,12184,8928,14296,9370,11583,4518,8400;22347,17175,12345,11172,8055,13406,25120,18409,12185,3054;20350,25163,25709,24673,18518,18120,15682,16199,11322,8515;18007,25711,24624,19687,18260,17846,18992,19310,12798,4924;14011,17009,33127,43450,40115,17457,11806,4541,2214,3139;30898,31302,23635,13389,14221,13755,5386,4660,7470,6626;21421,21069,16734,11169,19567,27284,22708,15080,9367,4118;19776,28677,28485,23982,13033,13434,13393,8617,6694,1709;19960,25444,22756,20083,19975,17906,24243,12253,4173,1968;16930,27725,33074,43193,24965,14418,7310,5235,2374,3302;32651,26500,10230,0,0,7502,8369,3388,4146,2085;24322,19047,3739,2642,4108,14467,27598,18015,8664,3591;15334,19695,24573,15766,5788,12524,13659,7398,10401,3501;16957,24773,19228,7550,9173,13660,24488,18019,8754,8389;8812,21174,31731,44638,29998,12924,12490,4609,8086,1503;20208,30399,23061,11183,0,7047,10370,14610,13168,8013;16451,20642,10954,1176,369,6908,23268,30137,14017,7108;22015,18339,24331,20112,14085,8793,14230,21352,7558,2535;13489,17816,25178,15977,7720,11381,21092,23870,14092,7805;5729,13982,20465,35689,42753,28773,19434,14090,10006,8719;29641,29895,25191,20008,14698,13655,11986,7942,4580,3278;20735,21027,16187,9969,10468,16519,28534,22661,11442,6909;21805,25753,24872,21004,22240,21843,21039,14819,5570,5475;18995,21829,26117,18179,15869,20261,20873,18185,8044,6550;14498,18599,30964,40654,32126,21579,17569,6556,8984,2326;30546,31865,32710,20782,10841,14218,11651,11174,7872,3859;26826,22925,16948,11263,11699,17697,27529,23237,7743,3957;20173,21862,24339,26301,18924,19257,20031,14238,10241,11172;17942,23978,23487,27581,24977,26157,24671,17631,12688,6647;13456,20975,31571,44599,35084,25872,12127,6399,8124,9613;32549,24075,14669,6404,6270,2914,11799,1749,3243,4376;21686,12006,4133,1360,9649,16803,21998,11285,2089,4580;17998,28732,18913,13339,7520,16800,16485,5986,3515,1728;21006,23216,15218,14547,10820,13901,18537,10658,4249,2219;18429,25174,38784,43412,23186,6421,7271,3307,4985,8045;26228,27473,25975,9225,9479,10786,11401,6303,11020,8515;23718,20932,12549,7511,8595,12243,27640,20851,9653,6896;15522,24296,28178,22321,15520,16449,14256,17037,10164,2717;20081,20324,20398,17790,12826,19602,16848,17006,9099,8462;14484,16288,32598,46249,37348,21779,7477,10661,8122,7842;18354,25394,22547,9802,3177,10305,13061,10905,9578,4492;16193,15515,6332,3709,2050,10127,19839,20343,15592,10274;13483,16288,19374,20157,9545,7085,19931,11303,11398,3131;12876,18108,15991,18136,6996,9822,12604,25275,11571,3890;5172,7609,15801,27158,33395,24007,12714,12353,3308,6925;27721,32355,34046,13860,2929,10157,13341,18284,11011,10989;21012,19183,14726,10554,4726,7934,18483,33345,16597,11585;17058,22343,22181,24024,15280,12962,19608,18574,19322,12753;13941,23976,21313,19811,12960,14468,17980,26634,15900,6795;6892,10244,18962,37337,45086,36477,21681,12168,11218,9294;24599,31833,16080,6888,7746,9631,13782,4149,2297,6365;19169,18605,7906,1348,8251,15339,22329,19548,7716,9428;15221,18835,28206,18305,16225,16953,19659,14899,4371,7397;14932,22096,24873,16246,12335,13534,18097,15509,10412,7669;12284,19897,29145,43168,29286,19103,6055,3621,7728,2851;20789,16745,17960,15404,12915,5320,4907,2746,5751,7616;18800,14168,14579,12837,18290,16976,12025,5559,6692,5656;18690,20951,21914,13826,19363,14757,10277,9074,5687,8783;17160,14336,15606,12171,13442,12841,13546,9610,8184,8959;18741,23333,19797,22798,14935,7661,9730,2660,2807,6932;22677,14636,19409,16367,9697,6367,2013,2535,7048,6311;17281,20227,15287,16980,11012,10603,11397,4143,1521,7290;13264,20079,20038,17695,12107,15113,10987,7228,2009,5632;19425,13876,18352,12733,17588,11054,7020,4516,2323,2745;20561,20409,26415,13322,7969,7356,1383,2223,3149,8734;15170,16873,23343,32021,43176,56141,73559,70596,22300,4178;9914,13788,19112,26318,35764,47518,66374,66160,43365,18678;9641,12420,17227,23755,32371,43051,55079,63118,52138,36528;8044,11193,15530,21427,29232,38971,59207,58675,50554,37173;7795,10849,15062,20805,28449,38111,56303,60480,50954,31404;10099,14059,19527,26997,36981,51273,66125,78422,39503,13079;9802,13630,18889,25998,35297,46578,61515,63643,44027,27410;9796,13620,18869,25953,35187,51034,63472,68688,45608,31252;7058,9829,13657,18896,25927,34974,47951,59166,55932,41973;9871,13729,19032,26212,35631,49518,67855,70467,48537,18650;12063,16754,23160,31720,42629,59982,67373,58972,24034,4072;12219,16977,23487,32218,43437,61310,76991,65884,21751,6455;9464,13166,18260,25172,34282,50485,65973,66664,45408,20914;9325,7556,6236,6238,0,0,0,0,2731,104;6448,8397,1127,534,0,0,0,0,2253,2528];
w=getx_snn(net);
delay=cell2mat_snn(net.snmParam.delay);
gamma=cell2mat(net.snmParam.gamma);

if (doValidation)
    VV.net = net;
    VV.epoch=0;
    VV.perf = Inf;
    VV.numFail = 0;
end


for epoch=0:epochs
    fprintf('Starting Epoch %d/%d\n',epoch,epochs)
    [perf,E,output,ta,w,noFire]=calcperf_snn(net,ti,td,w,delay);

    if (doValidation)
        if VV.same==true
            vperf=perf;
            voutput=output;
        else
            [vperf,E,voutput] = calcperf_snn(net,VV.ti,VV.td,w,delay);
        end
        if (vperf < VV.perf)
            VV.perf = vperf; VV.net = net; VV.epoch=epoch; VV.numFail = 0;
        elseif (vperf > VV.perf)
            VV.numFail = VV.numFail + 1;
        end
    end

   
    epochPlus1=epoch+1;
    tr.perf(epochPlus1)=perf;
    tr.output{epochPlus1}=output;
    tr.w{epochPlus1}=w;
    if (doValidation)
        tr.vperf(epochPlus1) = vperf;
        tr.voutput{epochPlus1}=voutput;
    end
    if lr_gamma
        tr.gamma{epochPlus1}=gamma;
    end
    if lr_delay
        tr.delay{epochPlus1}=delay;
    end

  
    if noFire==true
        stop='Some neurons stop firing.';
    elseif perf<=goal
        stop='Performance goal met.';
    elseif epoch==epochs
        stop='Maximum epoch reached, performance goal was not met.';
    elseif (doValidation) && (VV.numFail > max_fail)
        stop='Validation stop.';
    end

   
    if ~rem(epoch,show) || ~isempty(stop)
        fprintf(this);
        fprintf(', Epoch %d/%d',epoch,epochs)
        fprintf(', MSE %g/%g',perf,goal);
        fprintf('\n')
    end


    if ~isempty(stop)
        if (doValidation)
            net=VV.net;
            tr.vepoch=VV.epoch;
        end
        fprintf('%s, %s\n',this,stop);
        break
    end

    [~,gw_sum,gGamma_sum,gDelay_sum]=calcgx_snn(net,td,ta,w,delay);

    if lr
        
        dw=-lr*gw_sum;
        w=w+dw;
        
        if negWeights==false
            w=max(w,0);
        end
        
        net=setx_snn(net,'''w''',w);
    end

    if lr_gamma
        dg=-lr_gamma*gGamma_sum;
        gamma=gamma+dg;
        gamma=max(gamma,1);
        net.snmParam.gamma=[{[]};mat2cell(gamma,s(2:numLayers),1)];
    end
    if lr_delay
        dd=-lr_delay*gDelay_sum;
        delay=delay+dd;
        delay=max(delay,0);
        net=setx_snn(net,'''snmParam'',''delay''',delay);
    end
end


tr.epoch=0:epoch;

